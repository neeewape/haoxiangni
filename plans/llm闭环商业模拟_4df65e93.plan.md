---
name: LLM闭环商业模拟
overview: 用LLM生成/改进“实验设计方案”（假设、模型、校准方法、检验流程、指标体系）与策略参数，用可重复的仿真与检验模块产出收益、回撤与约束达标性，并由LLM基于反馈自动迭代直到满足月度+1%目标或触发停机条件。
todos:
  - id: define-metrics
    content: 明确月1%目标的评价口径与停机条件（收益分布、回撤分布、亏损概率、保证金/爆仓风险阈值）。
    status: pending
  - id: data-contracts
    content: 列出并固化所需数据字段与口径：期货、期权链、支撑/压力与方向信号、成本与交易规则。
    status: pending
    dependencies:
      - define-metrics
  - id: sim-engine
    content: 搭建最小可运行模拟引擎：价格路径（随机游走+可选波动聚集/跳跃）+ 双卖/对冲/10%敞口 + 行权接货处置 + 保证金与成本。
    status: pending
    dependencies:
      - data-contracts
  - id: assumption-tests
    content: 实现并出报告：短期随机游走检验、长期供需因子解释、方向90%命中率检验、策略在压力情景下的达标性。
    status: pending
    dependencies:
      - data-contracts
      - sim-engine
  - id: llm-loop
    content: 实现LLM闭环：生成实验设计方案（假设/模型/校准/检验/指标/策略参数）→运行评估→结构化反馈→自动修正，直至达标/收敛/预算停机。
    status: pending
    dependencies:
      - sim-engine
      - assumption-tests
---

# LLM驱动红枣期权对冲“月1%”商业模拟系统（简化闭环）

## 目标与输出

- **目标**：在“现货团队给的支撑/压力位”附近做双卖（类似短跨式/宽跨式），用期货对冲并**保留10%敞口**且与大方向一致，评估是否能达到**月度收益+1%**。
- **输出**：
- **整个实验思路**（含蒙特卡洛/压力测试/回测口径）
- **实验假定清单**（可切换、可检验）
- **所需数据与前提**（最小集 + 可选增强）
- **结果指标**：月度收益分布、最大回撤分布、亏损概率、保证金占用/爆仓概率、行权/接货情景占比、以及“推荐头寸规模区间”。

## 闭环流程（LLM自驱动迭代）

### 核心对象

- **Candidate（候选方案）**：一组可执行参数 + 可检验假设，例如：
- 双卖结构：Delta/距离（相对支撑/压力偏移）、到期选择（1个月）、卖出数量
- 对冲规则：Delta对冲频率、对冲阈值、保留10%方向敞口的实现方式
- 行权/接货规则：被行权后转为现货/期货头寸的处理、基差/仓储/资金成本
- 风控：止损/减仓触发、保证金安全垫
- **Experiment Design（实验设计方案）**：LLM 在每轮迭代中可改写的实验系统蓝图，包含：
  - 核心假设：短期随机游走、长期供需驱动、方向信号命中率、接货可行性
  - 模型结构：价格过程（GBM/GARCH/跳跃/状态切换）、隐含波动/偏度建模
  - 校准方法：历史波动、期权链反推、混合校准与稳健性处理
  - 检验流程：随机游走检验、供需因子解释、信号命中率验证、压力情景回测
  - 指标体系：收益/回撤/亏损概率/保证金风险/尾部损失（CVaR 等）与停机条件
- **Evaluator（评估器）**：对每个候选方案跑同一套仿真/回测，输出指标与诊断。
- **Critic（反馈分析）**：把失败原因结构化（比如尾部风险来自跳跃/波动聚集/对冲成本/保证金），喂给LLM。

### 迭代步骤（最小可落地）

1. **LLM生成候选方案**：给出实验设计方案 + 参数设置 + 明确“为什么这样设”
2. **构建/迭代仿真系统**：把实验设计与策略参数落地到同一套模拟引擎
3. **测试与验证**：

- 基线：历史回测（若数据足够）
- 主体：蒙特卡洛（校准波动/相关结构）
- 压力：极端波动、跳空、流动性/滑点恶化

4. **分析反馈**：输出“指标是否达标 + 失败分解 + 实验设计缺陷诊断”
5. **LLM修正/补全**：更新实验设计方案（假设/模型/校准/检验/指标）与策略参数，进入下一轮

### 停机条件（LLM决定是否“足够好”）

- **达标停机**：
- 月度收益的**中位数 ≥ 1%**，且
- **亏损概率 ≤ p_max**（默认先用 25% 作为占位，可调整），且
- **最大回撤（95%分位） ≤ DD_max**（默认先用 10% 作为占位，可调整），且
- 关键敏感性（手续费/滑点/波动上调/支撑压力偏移）下仍不崩。
- **收敛停机**：连续 N 轮（默认 5）目标函数提升 < ε（默认 0.1%）或改动只带来“回撤换收益”的无效摆动。
- **预算停机**：达到最大迭代轮数/计算预算。

## 实验思路（你要求的“例如蒙特卡洛”版本）

### 1) 价格过程：短期随机游走 + 长期供需决定（可检验）

- **短期（1个月）**：对期货对数价格用随机游走/扩散过程作为主模型：
- 基础：几何布朗运动（GBM）或离散随机游走
- 增强（推荐但仍简单）：带波动聚集（GARCH）或带跳跃（Poisson jump）以捕捉尾部
- **长期（多月到年）**：用“供需因子”决定漂移/状态（上行/下行/震荡）
- 做法：把“现货团队的大方向判断”视为一个**状态变量 regime**，影响短期漂移符号与大小（但不直接决定路径细节）。

### 2) 现货团队优势如何进入模型

- **优势A：被行权后可接货**：
- 在模拟里显式建模“被行权 → 转现货/期货库存”的处置路径：
- 选择1：接货后用期货/远月套保锁定风险
- 选择2：接货后按基差/仓储/资金成本持有至预期窗口
- **优势B：大方向90%正确率**：
- 把方向判断作为信号 S∈{Up,Down,Flat}，设定命中率 90%，用于：
- 决定保留10%敞口的方向（顺势）
- 调整双卖的偏度：例如看涨时卖Put更靠近支撑、Call更远离压力（反之亦然）

### 3) 策略建模：支撑/压力“双卖 + 期货对冲 + 10%敞口”

- **建仓**：每月选近月到期（~30天），
- 在“支撑位附近卖Put，在压力位附近卖Call”（等价于以S/R为锚的短宽跨式）
- **对冲**：
- Delta对冲：用期货动态调整
- 10%敞口：把目标净Delta限制在 
\[\Delta_{net} = 0.1 \times \Delta_{direction}\]
其中 \(\Delta_{direction}\) 由现货团队方向决定（上行保留正Delta，下行保留负Delta，震荡则趋近0）
- **交易成本/保证金**：必须进入PnL与回撤：手续费、滑点、保证金占用、追加保证金触发。

### 4) 蒙特卡洛实验如何跑

- **校准**：用历史期货收益率估计波动/尾部；用期权链估计隐含波动与偏度（若可得）。
- **路径生成**：每个“月度周期”生成 N 条路径（例如 50k），每条路径日频或更高频推进。
- **逐路径回放策略**：在每个时间步按规则更新Delta对冲、保证金、触发条件、到期行权结算/接货。
- **输出分布**：
- 月度收益分布（均值/中位数/分位数）
- 最大回撤分布（尤其95%/99%分位）
- 亏损概率、尾部（最差1%）
- 保证金占用峰值、爆仓/追加保证金频次

## “验证前四项是否成立”的检验设计

1. **短期随机游走**（1个月尺度）

- 检验：自相关（ACF/Ljung-Box）、方差比检验（Variance Ratio）、单位根/随机游走检验
- 结论：若显著偏离随机游走，则需要把短期漂移或均值回复纳入模型

2. **长期供需决定趋势**（多月尺度）

- 检验：用供需/库存/开秤收购/进口替代等月度因子解释中长期收益或趋势状态（回归/分类）

3. **现货团队大方向90%正确率**

- 检验：对其历史判断做方向命中率与置信区间（避免样本太小导致“90%”不稳）

4. **S/R双卖 + 对冲 + 10%敞口 能稳定产出月1%**

- 检验：在多情景（波动上调、跳跃、支撑压力偏移、流动性变差）下仍满足停机条件

## 实验假定（先给最小集，后续可让LLM迭代替换）

- **市场与合约**：郑商所红枣期货与对应期权，使用公开交易规则（行权方式、结算、交易时间）。
- **价格过程**：1个月内收益率近似随机游走，波动可随时间变化；极端风险用跳跃或压力情景覆盖。
- **信号有效性**：方向信号命中率接近90%，但需要用历史验证并给出置信区间。
- **可交易性**：能以可接受滑点成交；对冲可按设定频率执行。
- **接货能力**：被行权后接货与仓储/资金安排可执行，成本可量化。

## 数据与前提（你需要准备什么）

### 最小数据集（能跑起来）

- **期货**：红枣期货历史日线/分钟线（至少2-3年更稳）
- **期权链**：每日（或更高频）期权报价/隐含波动/Greeks（至少近月）
- **交易规则**：合约乘数、最小变动价位、保证金、手续费、行权/结算规则
- **成本参数**：滑点假设、手续费、资金利率
- **现货团队信号**：
- 每期给出的支撑/压力位
- 每期给出的方向（涨/跌/震荡）与时间戳

### 可选增强（用于“长期供需决定”验证）

- **现货/基差**：现货价格、基差、仓单/库存
- **供需因子**：产量、开秤收购、库存、替代品价格、进口等（月度）
- **事件标签**：政策/天气/突发事件（用于跳跃情景）

## 迭代准备清单（长时间/重计算/重记忆）

### 1) 数据与口径冻结（确保可重复）

- **数据版本与口径**：期货/期权链/信号/交易规则/成本参数的版本号与更新时间。
- **时间窗与频率**：训练、验证、压力测试的时间段划分与频率一致性。
- **现货团队信号记录**：支撑/压力位、方向判断、时间戳与来源，确保可回溯。
  - 建议输出：`signals.csv`（columns: date, support, resistance, direction, source）

### 2) 计算与运行环境准备（确保可扩展）

- **算力与并行**：明确是否需要并行/抽样以支撑蒙特卡洛与压力测试。
- **可复现实验参数**：随机种子、路径数量、回测步长、对冲频率固定化。
- **结果存档策略**：每轮输出的收益/回撤/尾部风险/保证金轨迹按轮次归档。
  - 建议输出目录：`runs/iter_{k}/`（保存输入参数、结果摘要与诊断报告）

### 3) 记忆与日志结构化（确保可迭代）

- **统一迭代日志模板**：
  - 实验设计版本（假设/模型/校准/检验/指标）
  - 策略参数版本（双卖/对冲/敞口/风控）
  - 结果摘要（收益/回撤/亏损概率/保证金风险）
  - 失败诊断（结构化原因 + 改进建议）
- **变更追踪**：每轮改动点与影响范围要可追溯，避免“盲改”。
  - 建议格式：`change_log.md`，包含“改动项/原因/影响指标/风险提示”。

### 4) 停机条件与预算上限（确保可收敛）

- **达标停机**：满足收益/回撤/亏损概率等硬性指标。
- **收敛停机**：连续 N 轮改进不足。
- **预算停机**：最大迭代轮数/计算预算/时间预算。

## 准备执行清单（可直接落地）

### A) 数据与口径冻结（打勾完成）

- [ ] 固定历史期货数据范围与频率（写入 `data_contracts.md`）。
- [ ] 固定期权链字段与日历规则（写入 `data_contracts.md`）。
- [ ] 固定交易规则与成本参数（写入 `data_contracts.md`）。
- [ ] 固定现货团队信号口径与存储格式（`signals.csv`）。

### B) 计算可复现设置（打勾完成）

- [ ] 设定随机种子（记录在 `runs/iter_0/config.json`）。
- [ ] 设定路径数/步长/对冲频率（记录在 `runs/iter_0/config.json`）。
- [ ] 设定并行/抽样策略与资源预算（记录在 `runs/iter_0/config.json`）。

### C) 迭代日志模板（打勾完成）

- [ ] 创建 `runs/iter_0/summary.md`，包含：
  - 实验设计版本（假设/模型/校准/检验/指标）
  - 策略参数版本（双卖/对冲/敞口/风控）
  - 结果摘要（收益/回撤/亏损概率/保证金风险）
  - 失败诊断（结构化原因 + 改进建议）
- [ ] 创建 `change_log.md`，记录每轮改动与影响。

### D) 停机条件与预算（打勾完成）

- [ ] 明确收益/回撤/亏损概率阈值（写入 `define_metrics.md`）。
- [ ] 明确收敛阈值与迭代上限（写入 `define_metrics.md`）。

## 交付物（保持简单）

- 一个最小“模拟引擎”+“策略参数”+“评估报告”框架：
- 策略参数表（可由LLM生成/更新）
- 一键运行输出：收益/回撤/保证金/行权接货情景
- 诊断报告：哪些假设成立、哪些不成立、下一轮该改什么

## 实施Todos（精简）

- `define-metrics`: 定义目标函数、约束与停机条件（收益、回撤、亏损概率、保证金风险）
- `data-contracts`: 定义数据字段与口径（期货/期权链/信号/成本/规则）
- `sim-engine`: 实现路径生成+策略回放（含对冲、保证金、行权/接货处置）
- `assumption-tests`: 实现4项假设的统计检验与报告
- `llm-loop`: 实现LLM提案→运行→反馈→改进的循环与日志
